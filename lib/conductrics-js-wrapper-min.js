(function(){var CookieLite,MicroAjax,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__slice=[].slice;window.ConductricsJS=function(){function ConductricsJS(owner,apikey,opts){var _base,_base1,_base2,_base3,_base4,_base5,_base6,_base7,_base8,_ref;this.owner=owner,this.apikey=apikey,this.opts=null!=opts?opts:{},this.send=__bind(this.send,this),this.goal=__bind(this.goal,this),this.decision=__bind(this.decision,this),null==(_base=this.opts).server&&(_base.server="//api.conductrics.com"),null==(_base1=this.opts).timeout&&(_base1.timeout=5e3),null==(_base2=this.opts).cookies&&(_base2.cookies={ttl:2592e3,path:"/"}),null==(_base3=this.opts).scodestore&&(_base3.scodestore=CookieLite),null==(_base4=this.opts).session&&(_base4.session="function"==typeof(_base5=this.opts).scodestore?_base5.scodestore("mpid"):void 0),null==(_base6=this.opts).transport&&(_base6.transport=MicroAjax),null==(_base7=this.opts).batching&&(_base7.batching="off"),null==(_base8=this.opts).batchingSkipsPreflight&&(_base8.batchingSkipsPreflight=!0),("auto"===(_ref=this.opts.batching)||"manual"===_ref)&&this.batchStart()}var debounce,keepId,qsformat,_batchItem,_batchSend;return ConductricsJS.prototype.decision=function(agent,opts,cb){var fb,key,url,val,_ref;if(null==opts&&(opts={}),null==cb&&(cb=null),url=[agent,"decisions"],fb=null,null!=opts.choices){_ref=opts.choices;for(key in _ref)val=_ref[key],null!=(null!=val?val.join:void 0)&&(url.push(""+key+":"+val.join(",")),null==fb&&(fb={}),fb[key]||(fb[key]={code:val[0]}));delete opts.choices}return null!=opts.fallback&&(fb=opts.fallback,delete opts.fallback),this.send(url,opts,null,!0,function(_this){return function(res){var selection,_ref1;return keepId(_this.opts,null!=res?res.session:void 0),null!=cb?(selection=null!=(_ref1=null!=res?res.decisions:void 0)?_ref1:fb,cb(selection,null!=res?res.session:void 0)):void 0}}(this))},ConductricsJS.prototype.goal=function(agent,opts,cb){var url;return url=[agent,"goal"],null!=opts.goal&&(url.push(opts.goal),delete opts.goal),this.send(url,opts,null,!0,function(_this){return function(res){var accepted,retryable;return keepId(_this.opts,null!=res?res.session:void 0),null!=cb?(accepted=(null!=res?res.reward:void 0)>0,retryable=null==(null!=res?res.agent:void 0),cb(accepted,null!=res?res.session:void 0,retryable)):void 0}}(this))},ConductricsJS.prototype.send=function(url,data,body,batchable,cb){var _ref;return data.apikey=this.apikey,null!=this.opts.session&&(data.session=this.opts.session),data._t=(new Date).getTime(),!batchable||"auto"!==(_ref=this.opts.batching)&&"manual"!==_ref?(url=""+this.opts.server+"/"+this.owner+"/"+url.join("/")+"?"+qsformat(data),new this.opts.transport(url,body,this.opts.timeout,function(){return function(text){var e,res;try{return res=JSON.parse(text),cb(res)}catch(_error){return e=_error,cb(null)}}}(this))):(this.batch.push(_batchItem(url,data,cb)),void("auto"===this.opts.batching&&_batchSend(this)))},qsformat=function(data){var k,qs,v;qs="";for(k in data)v=data[k],qs+="&"+k+"="+escape(v);return qs},keepId=function(opts,session){return null!=session&&null!=opts.cookies?(opts.session=session,"function"==typeof opts.scodestore?opts.scodestore("mpid",session,opts.cookies):void 0):void 0},debounce=function(ms,f){var timeout;return timeout=null,function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],clearTimeout(timeout),setTimeout(function(_this){return function(){return f.apply(_this,a)}}(this),ms)}},ConductricsJS.prototype.batchStart=function(){return this.batch=[]},ConductricsJS.prototype.batchSend=function(){var batched,params,url;return url=["-","batch"],batched=this.batch.concat(),this.batchStart(),batched.length>0?(params=this.opts.batchingSkipsPreflight?{_type:"json"}:{},this.send(url,params,batched,!1,function(results){var i,item,_results;_results=[];for(i in batched)item=null!=results?results[i]:void 0,_results.push(batched[i].cb(null!=item?item.data:void 0));return _results})):void 0},_batchSend=debounce(20,function(self){return self.batchSend()}),_batchItem=function(url,data,cb){var item;switch(item={agent:url[0],type:url[1],query:data,cb:cb},item.type){case"decisions":url.length>2&&(item.choices=url.slice(2).join("/"));break;case"goal":url.length>2&&(item.goal=url[2])}return item},ConductricsJS}(),CookieLite=function(name,value,opts){var str;return arguments.length>1?(str=name+"="+escape(value)+(null!=opts.ttl?"; expires="+new Date(+new Date+1e3*opts.ttl).toUTCString():"")+(null!=opts.path?"; path="+opts.path:""),(null!=opts.domain?"; domain="+opts.domain:"")+(null!=opts.secure?"; secure":""),document.cookie=str):unescape((("; "+document.cookie).split("; "+name+"=")[1]||"").split(";")[0])},MicroAjax=function(){function MicroAjax(url,body,timeout,callback){var req;return req=createRequest(url,body),null==req?callback(null):("number"==typeof timeout&&(req.timeout=timeout),req.onload=function(){return callback(req.responseText)},req.onerror=req.ontimeout=function(){return callback(null)},void(null!=body?(url.indexOf("_type=json")>0||req.setRequestHeader("Content-Type","application/json"),req.send(JSON.stringify(body))):req.send()))}var createRequest;return createRequest=function(url,body){var method,xhr;return method=null!=body?"POST":"GET","undefined"!=typeof XMLHttpRequest&&null!==XMLHttpRequest&&(xhr=new XMLHttpRequest),null!=(null!=xhr?xhr.withCredentials:void 0)?xhr.open(method,url,!0):"undefined"!=typeof XDomainRequest&&null!==XDomainRequest?(xhr=new XDomainRequest,xhr.open(method,url)):xhr=null,xhr},MicroAjax}()}).call(this);