// Generated by CoffeeScript 1.10.0
(function() {
  var CookieLite, MicroAjax,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    slice = [].slice;

  window.ConductricsJS = (function() {
    var _batchItem, _batchSend, debounce, keepId, qsformat;

    function ConductricsJS(owner, apikey, opts1) {
      var base, base1, base2, base3, base4, base5, base6, base7, base8, ref;
      this.owner = owner;
      this.apikey = apikey;
      this.opts = opts1 != null ? opts1 : {};
      this.send = bind(this.send, this);
      this.goal = bind(this.goal, this);
      this.decision = bind(this.decision, this);
      if ((base = this.opts).server == null) {
        base.server = '//api.conductrics.com';
      }
      if ((base1 = this.opts).timeout == null) {
        base1.timeout = 5000;
      }
      if ((base2 = this.opts).cookies == null) {
        base2.cookies = {
          ttl: 60 * 60 * 24 * 30,
          path: '/'
        };
      }
      if ((base3 = this.opts).scodestore == null) {
        base3.scodestore = CookieLite;
      }
      if ((base4 = this.opts).session == null) {
        base4.session = typeof (base5 = this.opts).scodestore === "function" ? base5.scodestore('mpid') : void 0;
      }
      if ((base6 = this.opts).transport == null) {
        base6.transport = MicroAjax;
      }
      if ((base7 = this.opts).batching == null) {
        base7.batching = 'off';
      }
      if ((base8 = this.opts).batchingSkipsPreflight == null) {
        base8.batchingSkipsPreflight = true;
      }
      if ((ref = this.opts.batching) === 'auto' || ref === 'manual') {
        this.batchStart();
      }
    }

    ConductricsJS.prototype.decision = function(agent, opts, cb) {
      var fb, key, ref, url, val;
      if (opts == null) {
        opts = {};
      }
      if (cb == null) {
        cb = null;
      }
      url = [agent, 'decisions'];
      fb = null;
      if (opts.choices != null) {
        ref = opts.choices;
        for (key in ref) {
          val = ref[key];
          if (!((val != null ? val.join : void 0) != null)) {
            continue;
          }
          url.push(key + ":" + (val.join(',')));
          if (fb == null) {
            fb = {};
          }
          if (!fb[key]) {
            fb[key] = {
              code: val[0]
            };
          }
        }
        delete opts.choices;
      }
      if (opts.fallback != null) {
        fb = opts.fallback;
        delete opts.fallback;
      }
      return this.send(url, opts, null, true, (function(_this) {
        return function(res) {
          var ref1, selection;
          keepId(_this.opts, res != null ? res.session : void 0);
          if (cb == null) {
            return;
          }
          selection = (ref1 = res != null ? res.decisions : void 0) != null ? ref1 : fb;
          return cb(selection, res != null ? res.session : void 0);
        };
      })(this));
    };

    ConductricsJS.prototype.goal = function(agent, opts, cb) {
      var url;
      url = [agent, 'goal'];
      if (opts.goal != null) {
        url.push(opts.goal);
        delete opts.goal;
      }
      return this.send(url, opts, null, true, (function(_this) {
        return function(res) {
          var accepted, retryable;
          keepId(_this.opts, res != null ? res.session : void 0);
          if (cb == null) {
            return;
          }
          accepted = (res != null ? res.reward : void 0) > 0;
          retryable = (res != null ? res.agent : void 0) == null;
          return cb(accepted, res != null ? res.session : void 0, retryable);
        };
      })(this));
    };

    ConductricsJS.prototype.send = function(url, data, body, batchable, cb) {
      var ref;
      data.apikey = this.apikey;
      if (this.opts.session != null) {
        data.session = this.opts.session;
      }
      data._t = new Date().getTime();
      if (batchable && ((ref = this.opts.batching) === 'auto' || ref === 'manual')) {
        this.batch.push(_batchItem(url, data, cb));
        if (this.opts.batching === 'auto') {
          _batchSend(this);
        }
        return;
      }
      url = this.opts.server + "/" + this.owner + "/" + (url.join('/')) + "?" + (qsformat(data));
      return new this.opts.transport(url, body, this.opts.timeout, (function(_this) {
        return function(text) {
          var e, error, res;
          try {
            res = JSON.parse(text);
            return cb(res);
          } catch (error) {
            e = error;
            return cb(null);
          }
        };
      })(this));
    };

    qsformat = function(data) {
      var k, qs, v;
      qs = '';
      for (k in data) {
        v = data[k];
        qs += "&" + k + "=" + (escape(v));
      }
      return qs;
    };

    keepId = function(opts, session) {
      if ((session != null) && (opts.cookies != null)) {
        opts.session = session;
        return typeof opts.scodestore === "function" ? opts.scodestore('mpid', session, opts.cookies) : void 0;
      }
    };

    debounce = function(ms, f) {
      var timeout;
      timeout = null;
      return function() {
        var a;
        a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
        clearTimeout(timeout);
        return setTimeout(((function(_this) {
          return function() {
            return f.apply(_this, a);
          };
        })(this)), ms);
      };
    };

    ConductricsJS.prototype.batchStart = function() {
      return this.batch = [];
    };

    ConductricsJS.prototype.batchSend = function() {
      var batched, params, url;
      url = ['-', 'batch'];
      batched = this.batch.concat();
      this.batchStart();
      if (!(batched.length > 0)) {
        return;
      }
      params = this.opts.batchingSkipsPreflight ? {
        _type: 'json'
      } : {};
      return this.send(url, params, batched, false, function(results) {
        var i, item, results1;
        results1 = [];
        for (i in batched) {
          item = results != null ? results[i] : void 0;
          results1.push(batched[i].cb(item != null ? item.data : void 0));
        }
        return results1;
      });
    };

    _batchSend = debounce(20, function(self) {
      return self.batchSend();
    });

    _batchItem = function(url, data, cb) {
      var item;
      item = {
        agent: url[0],
        type: url[1],
        query: data,
        cb: cb
      };
      switch (item.type) {
        case 'decisions':
          if (url.length > 2) {
            item.choices = url.slice(2).join('/');
          }
          break;
        case 'goal':
          if (url.length > 2) {
            item.goal = url[2];
          }
      }
      return item;
    };

    return ConductricsJS;

  })();

  CookieLite = function(name, value, opts) {
    var str;
    if (arguments.length > 1) {
      str = name + "=" + escape(value) + (opts.ttl != null ? "; expires=" + new Date(+new Date() + (1e3 * opts.ttl)).toUTCString() : "") + (opts.path != null ? "; path=" + opts.path : "") + (opts.domain != null ? "; domain=" + opts.domain : "") + (opts.secure != null ? "; secure" : "");
      return document.cookie = str;
    }
    return unescape((("; " + document.cookie).split("; " + name + "=")[1] || "").split(";")[0]);
  };

  MicroAjax = (function() {
    var createRequest;

    function MicroAjax(url, body, timeout, callback) {
      var req;
      req = createRequest(url, body);
      if (req == null) {
        return callback(null);
      }
      if (typeof timeout === 'number') {
        req.timeout = timeout;
      }
      req.onload = function() {
        return callback(req.responseText);
      };
      req.onerror = req.ontimeout = function() {
        return callback(null);
      };
      if (body != null) {
        if (!(url.indexOf('_type=json') > 0)) {
          req.setRequestHeader('Content-Type', 'application/json');
        }
        req.send(JSON.stringify(body));
      } else {
        req.send();
      }
    }

    createRequest = function(url, body) {
      var method, xhr;
      method = body != null ? 'POST' : 'GET';
      if (typeof XMLHttpRequest !== "undefined" && XMLHttpRequest !== null) {
        xhr = new XMLHttpRequest();
      }
      if ((xhr != null ? xhr.withCredentials : void 0) != null) {
        xhr.open(method, url, true);
      } else if (typeof XDomainRequest !== "undefined" && XDomainRequest !== null) {
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        xhr = null;
      }
      return xhr;
    };

    return MicroAjax;

  })();

}).call(this);
