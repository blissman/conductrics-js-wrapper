// Generated by CoffeeScript 1.6.3
(function() {
  var CookieLite, MicroAjax,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.ConductricsJS = (function() {
    var qsformat;

    function ConductricsJS(owner, apikey, opts) {
      var _base, _base1, _base2, _base3, _base4, _base5, _base6;
      this.owner = owner;
      this.apikey = apikey;
      this.opts = opts != null ? opts : {};
      this.send = __bind(this.send, this);
      this.goal = __bind(this.goal, this);
      this.decision = __bind(this.decision, this);
      if ((_base = this.opts).server == null) {
        _base.server = 'http://api.conductrics.com';
      }
      if ((_base1 = this.opts).timeout == null) {
        _base1.timeout = 5000;
      }
      if ((_base2 = this.opts).cookies == null) {
        _base2.cookies = {
          ttl: 60 * 60 * 24 * 30,
          path: '/'
        };
      }
      if ((_base3 = this.opts).scodestore == null) {
        _base3.scodestore = CookieLite;
      }
      if ((_base4 = this.opts).session == null) {
        _base4.session = typeof (_base5 = this.opts).scodestore === "function" ? _base5.scodestore('mpid') : void 0;
      }
      if ((_base6 = this.opts).transport == null) {
        _base6.transport = MicroAjax;
      }
    }

    ConductricsJS.prototype.decision = function(agent, opts, cb) {
      var fb, key, url, val, _ref;
      if (opts == null) {
        opts = {};
      }
      if (cb == null) {
        cb = null;
      }
      url = [agent, 'decisions'];
      fb = null;
      if (opts.choices != null) {
        _ref = opts.choices;
        for (key in _ref) {
          val = _ref[key];
          if (!((val != null ? val.join : void 0) != null)) {
            continue;
          }
          url.push("" + key + ":" + (val.join(',')));
          if (fb == null) {
            fb = {};
          }
          if (!fb[key]) {
            fb[key] = {
              code: val[0]
            };
          }
        }
        delete opts.choices;
      }
      return this.send(url, opts, function(res) {
        var selection, _ref1;
        if (cb == null) {
          return;
        }
        selection = (_ref1 = res != null ? res.decisions : void 0) != null ? _ref1 : fb;
        return cb(selection, res != null ? res.session : void 0);
      });
    };

    ConductricsJS.prototype.goal = function(agent, opts, cb) {
      var url;
      url = [agent, 'goal'];
      if (opts.goal != null) {
        url.push(opts.goal);
        delete opts.goal;
      }
      return this.send(url, opts, function(res) {
        var success;
        if (cb == null) {
          return;
        }
        success = (res != null ? res.session : void 0) != null;
        return cb(success, res != null ? res.session : void 0);
      });
    };

    ConductricsJS.prototype.send = function(url, data, cb) {
      var _this = this;
      if (data == null) {
        data = {};
      }
      data.apikey = this.apikey;
      if (this.opts.session != null) {
        data.session = this.opts.session;
      }
      data._t = new Date().getTime();
      url = "" + this.opts.server + "/" + this.owner + "/" + (url.join('/')) + "?" + (qsformat(data));
      return new this.opts.transport(url, this.opts.timeout, function(text) {
        var e, res, _base;
        try {
          res = JSON.parse(text);
          cb(res);
        } catch (_error) {
          e = _error;
          cb(null);
        }
        if (((res != null ? res.session : void 0) != null) && (_this.opts.cookies != null)) {
          _this.opts.session = res.session;
          return typeof (_base = _this.opts).scodestore === "function" ? _base.scodestore('mpid', res.session, _this.opts.cookies) : void 0;
        }
      });
    };

    qsformat = function(data) {
      var k, qs, v;
      qs = '';
      for (k in data) {
        v = data[k];
        qs += "&" + k + "=" + (escape(v));
      }
      return qs;
    };

    return ConductricsJS;

  })();

  CookieLite = function(name, value, opts) {
    var str;
    if (arguments.length > 1) {
      str = name + "=" + escape(value) + (opts.ttl != null ? "; expires=" + new Date(+new Date() + (1e3 * opts.ttl)).toUTCString() : "") + (opts.path != null ? "; path=" + opts.path : "");
      (opts.domain != null ? "; domain=" + opts.domain : "") + (opts.secure != null ? "; secure" : "");
      return document.cookie = str;
    }
    return unescape((("; " + document.cookie).split("; " + name + "=")[1] || "").split(";")[0]);
  };

  MicroAjax = (function() {
    var createRequest;

    function MicroAjax(url, timeout, callback) {
      var req;
      req = createRequest(url);
      if (req == null) {
        return callback(null);
      }
      if (typeof timeout === 'number') {
        req.timeout = timeout;
      }
      req.onload = function() {
        return callback(req.responseText);
      };
      req.onerror = req.ontimeout = function() {
        return callback(null);
      };
      req.send();
    }

    createRequest = function(url) {
      var xhr;
      if (typeof XMLHttpRequest !== "undefined" && XMLHttpRequest !== null) {
        xhr = new XMLHttpRequest();
      }
      if ((xhr != null ? xhr.withCredentials : void 0) != null) {
        xhr.open('GET', url, true);
      } else if (typeof XDomainRequest !== "undefined" && XDomainRequest !== null) {
        xhr = new XDomainRequest();
        xhr.open('GET', url);
      } else {
        xhr = null;
      }
      return xhr;
    };

    return MicroAjax;

  })();

}).call(this);
